# 01.01.01 - Theme Processor

## Overview

The Theme Processor is the core engine that transforms JSON theme configurations into live CSS. It provides a runtime CSS generation system that converts theme definitions into scoped, conflict-free stylesheets.

## Architecture

### Core Components

1. **RuntimeThemeProcessor Class**
   - Singleton instance for theme management
   - Handles theme loading and CSS generation
   - Manages style injection into the DOM

2. **Theme Configuration Structure**
   ```json
   {
     "class": "ui",          // Theme namespace
     "variables": {},        // CSS custom properties
     "presets": {},         // Style combinations
     "helpers": {},         // Utility classes
     "structure": {}        // UI layout (UI theme only)
   }
   ```

3. **CSS Generation Pipeline**
   - Load theme JSON
   - Generate CSS variables
   - Process presets with parent scoping
   - Generate helper classes
   - Inject styles into document

## Theme Structure

### Variables
Define CSS custom properties for the design system:
```json
"variables": {
  "backgroundColor": {
    "defaultValue": "hsl(0, 0%, 10%)",
    "type": "color",
    "category": "colors",
    "cssProperty": "--background-color"
  }
}
```

### Presets
Reusable style combinations organized by category:
```json
"presets": {
  "layout": {
    "dashboard": {
      "--display": "grid",
      "--grid-template-areas": "\"a a a\" \"c b d\""
    }
  },
  "typography": {
    "button": {
      "--padding": "8px 16px",
      "--border-radius": "6px"
    }
  }
}
```

### Helpers
Utility classes for common patterns:
```json
"helpers": {
  "positioning": {
    "a": { "--grid-area": "a" },
    "b": { "--grid-area": "b" }
  }
}
```

## CSS Output

The Theme Processor generates scoped CSS using parent classes:

```css
/* Theme root with all variables */
.ui {
  --background-color: hsl(0, 0%, 10%);
  --color: hsl(0, 0%, 90%);
  /* ... all 100+ variables ... */
  
  /* Apply variables to properties */
  background-color: var(--background-color);
  color: var(--color);
}

/* Presets scoped to theme */
.ui .dashboard {
  --display: grid;
  display: var(--display);
}

/* Helpers scoped to theme */
.ui .a {
  --grid-area: a;
  grid-area: var(--grid-area);
}
```

## Parent Scoping

All generated classes are scoped to their parent theme class to prevent conflicts:

- UI Theme: `.ui .className`
- ONE Theme: `.one .className`

This allows both themes to use identical class names without collision:
```css
.ui .button { /* UI button styles */ }
.one .button { /* ONE button styles */ }
```

## Categories

Categories in presets serve two purposes:
1. **Organization** - Group related styles
2. **UI Generation** - Can be used as section titles in visual editors

Categories are purely organizational and require no registration. Any category name will work:
```json
"presets": {
  "my-custom-category": {
    "my-preset": { /* styles */ }
  }
}
```

## API Reference

### Loading Themes
```typescript
// Load and apply a theme
await runtimeThemeProcessor.applyTheme('ui');
await runtimeThemeProcessor.applyTheme('one');
```

### Getting Theme Configuration
```typescript
const uiTheme = runtimeThemeProcessor.getTheme('ui');
const oneTheme = runtimeThemeProcessor.getTheme('one');
```

### Manual CSS Generation
```typescript
const css = runtimeThemeProcessor.generateCSS(themeConfig, 'ui');
runtimeThemeProcessor.injectCSS(css, 'ui-theme-styles');
```

## Theme Files

- **UI Theme**: `/public/data/themes/ui-theme.json`
- **ONE Theme**: `/public/data/themes/one-theme.json`

Both themes follow identical structure patterns for consistency.

---

## Development Notes

### Design Decisions

1. **Parent Scoping over Prefixing**
   - Originally used prefixes (ui-dashboard, ui-button)
   - Switched to parent scoping for cleaner class names
   - Results in more maintainable and readable code

2. **Unified Structure**
   - Both themes use "presets" instead of different names
   - Consistency makes the system easier to understand
   - Categories provide the differentiation needed

3. **Separation of Concerns**
   - Variables: Design tokens
   - Presets: Style combinations
   - Helpers: Utilities
   - Structure: Layout (UI only)

### Current Limitations

1. **No State Management**
   - Hover/active states must be defined manually
   - No automatic state generation yet

2. **Static Generation**
   - CSS is generated once at load time
   - No dynamic updates based on user actions

3. **No Inheritance**
   - Presets don't inherit from each other
   - Each preset must define all its styles

### Next Steps

1. **Programmatic State Generation**
   - Add automatic hover/active state creation
   - Color manipulation functions
   - State configuration system

2. **Dynamic Updates**
   - Live theme editing
   - Runtime preset switching
   - Hot reload support

3. **Enhanced Categories**
   - Category metadata
   - Category-based inheritance
   - Smart preset suggestions

### Code Organization

The Theme Processor is intentionally kept as a single file for simplicity. Key sections:
- Variable categorization
- CSS generation
- Style injection
- Helper utilities

### Performance Considerations

- CSS is generated once per theme load
- Style elements are reused, not duplicated
- Minimal runtime overhead
- Efficient parent selector usage